import time
import os
import subprocess

def read_gpio(pin):
    # Command to read GPIO value
    command = "gpio read " + str(pin)
    
    try:
        # Execute the command
        output = subprocess.check_output(command, shell=True, universal_newlines=True)
        # Strip any whitespace from the output
        return output.strip()
    except subprocess.CalledProcessError as e:
        print("Error reading GPIO pin {}: {}".format(pin, e))
        return None

devs = ['/sys/bus/w1/devices/28-3c840457ce28/w1_slave', '/sys/bus/w1/devices/28-3ce1d443e517/w1_slave']
#ouput_dir='/home/paolo/solarlog/luspam.github.io/riscaldamento/'
ouput_dir='/tmp/'

t = ["", ""]
for i in range(0, 2):
    with open(devs[i]) as f:
        lines = f.readlines()
        if len(lines) == 2 and "YES" in lines[0]:
            k = lines[1].find("t=")
            if k > 0:
                t[i] = str(float(lines[1][k+2:].replace("\n", "")) / 1000)
p0 = read_gpio(23)
p1 = read_gpio(22)
ts =  time.strftime("%Y-%m-%d %H:%M:%S")
month = time.strftime("%Y-%m")
path = ouput_dir + month + ".csv"
if not(os.path.isfile(path)):
    with open(path, "w") as myfile:
        myfile.write('t,T0,T1,P0,P1\n')
with open(path, "a") as myfile:
    myfile.write('%s,%s,%s,%s,%s\n' % (ts, t[0], t[1], p0, p1))
            
